# 티켓 예매 시스템 PRD

## 개요

**티켓 예매 시스템**은 대규모 트래픽을 처리하는 고성능 웹 애플리케이션으로, 콘서트, 스포츠 이벤트 등의 티켓 예매를 효율적이고 안정적으로 처리합니다. 이 시스템은 높은 TPS(Transactions Per Second)와 99.9% 이상의 가용성을 목표로 하며, 대기열 관리, 실시간 상태 업데이트, 푸시 알림 서비스를 통해 사용자 경험을 최적화합니다.

### 문제 해결
- **문제**: 대규모 트래픽이 몰리는 티켓 예매 시 서버 다운, 느린 응답, 불공정한 예매 경험 발생.
- **해결**: 분산 시스템(Kafka, Redis)과 클라우드 인프라(AWS, Kubernetes)를 활용해 안정성과 확장성을 보장하며, 대기열과 알림 서비스로 공정하고 편리한 예매 경험 제공.

### 대상 사용자
- **일반 사용자**: 티켓을 구매하려는 개인 (콘서트 팬, 스포츠 관중 등).
- **이벤트 주최자**: 티켓 판매를 위탁하는 기업 또는 단체.
- **운영자**: 시스템 모니터링 및 관리를 담당하는 내부 엔지니어.

### 가치
- 사용자에게 공정하고 빠른 예매 경험 제공.
- 주최자에게 안정적인 티켓 판매 플랫폼 제공.

---

## 핵심 기능

### 1. 사용자 인증
- **기능**: 사용자가 안전하게 로그인하고 세션을 유지.
- **중요성**: 보안성과 개인화된 예매 경험 제공.
- **동작 방식**:
    - JWT(JSON Web Token) 기반 인증.
    - Spring Security로 인증/인가 처리.
    - Redis에 세션 정보 캐싱(TTL 설정).

### 2. 대기열 시스템
- **기능**: 대규모 트래픽을 순차적으로 처리해 서버 부하 관리.
- **중요성**: 공정한 예매 기회 보장 및 서버 안정성 유지.
- **동작 방식**:
    - Redis Sorted Set으로 대기열 순번 관리.
    - 분산 락(Redlock 알고리즘)으로 동시성 제어.
    - 사용자가 대기열에 등록 후 순번 확인 가능.

### 3. 티켓 예매
- **기능**: 사용자가 티켓을 선택하고 결제 완료.
- **중요성**: 시스템의 핵심 비즈니스 로직.
- **동작 방식**:
    - Kafka로 예매 요청 비동기 처리.
    - MySQL에 티켓 재고 및 예매 기록 저장.
    - 결제 게이트웨이(외부 API) 연동.

### 4. 알림 서비스
- **기능**: 대기열에서 예매 가능 시 푸시 알림 전송.
- **중요성**: 사용자가 앱을 떠나도 예매 기회 제공, UX 개선.
- **동작 방식**:
    - 대기열 상태 변경 시 Kafka 이벤트 발행.
    - Spring Boot가 AWS SNS로 푸시 알림 전송.
    - Redis로 사용자 디바이스 토큰 관리.

### 5. 실시간 모니터링
- **기능**: 시스템 성능과 에러를 실시간 추적.
- **중요성**: 운영 안정성 확보 및 빠른 문제 대응.
- **동작 방식**:
    - Prometheus로 TPS, latency, 알림 성공률 수집.
    - Grafana로 대시보드 시각화.
    - ELK Stack으로 로그 분석.

---

## 사용자 경험

### 주요 사용자 플로우
1. **예매 플로우**:
    - 로그인 → 이벤트 선택 → 대기열 등록 → 순번 확인 → 예매 가능 알림 → 티켓 선택 → 결제 → 예매 완료.
2. **알림 플로우**:
    - 대기열 등록 → 앱 백그라운드 전환 → 푸시 알림 수신 → 링크 클릭 → 예매 화면 재진입.
3. **운영자 플로우**:
    - Grafana 대시보드 접속 → TPS/에러율 확인 → ELK로 로그 분석 → 문제 해결.

### UI/UX 고려사항
- **직관성**: 모바일/웹 친화적인 디자인, 최소 클릭으로 예매 완료.
- **실시간 피드백**: 대기열 순번, 예상 대기 시간 실시간 표시.
- **알림**: 푸시 알림에 명확한 CTA(Call to Action, 예: “지금 예매하기”) 포함.
- **접근성**: 색상 대비, 화면 리더 호환성 준수.

---

## 기술 아키텍처

### 시스템 구성 요소
- **Spring Cloud Gateway**: API 라우팅 및 인증 처리.
- **Spring Boot App**: 비즈니스 로직, API 제공.
- **Kafka**: 비동기 이벤트 처리(예매, 알림).
- **Redis**: 대기열, 캐싱, 세션 관리.
- **MySQL**: 티켓 재고, 사용자 데이터 저장.
- **AWS SNS**: 푸시 알림 전송.
- **Prometheus/Grafana**: 모니터링 및 시각화.
- **ELK Stack**: 로그 수집 및 분석.
- **Kubernetes**: 컨테이너 오케스트레이션.
- **Jenkins**: CI/CD 파이프라인.

### 데이터 모델
- **User**:
  ```sql
  id: BIGINT (PK)
  email: VARCHAR(255)
  password: VARCHAR(255)
  device_token: VARCHAR(255)
  ```
- **Ticket**:
  ```sql
  id: BIGINT (PK)
  event_id: BIGINT
  status: ENUM(AVAILABLE, RESERVED, SOLD)
  price: DECIMAL
  ```
- **Queue**:
  ```redis
  queue:{event_id}:users -> Sorted Set (score: timestamp, value: user_id)
  ```

### API 및 통합
- **REST API**:
    - `POST /api/tickets/reserve`: 티켓 예매 요청.
    - `GET /api/tickets/status`: 예매 상태 조회.
    - `POST /api/notifications/register`: 디바이스 토큰 등록.
- **외부 통합**:
    - AWS SNS: 푸시 알림.
    - 결제 게이트웨이(예: Stripe, 토스페이먼츠).
    - OpenAPI 스펙으로 문서화.

### 인프라 요구사항
- **AWS EC2**: Spring Boot 앱 호스팅.
- **AWS EKS**: Kubernetes 클러스터.
- **RDS (MySQL)**: 데이터베이스.
- **ElastiCache (Redis)**: 캐싱 및 대기열.
- **Kafka 브로커**: 메시징 시스템.
- **S3**: 로그 저장.
- **CloudWatch**: 기본 로그 수집.

---

## 개발 로드맵

### MVP 요구사항
- **사용자 인증**: JWT 기반 로그인/로그아웃.
- **대기열 시스템**: Redis 기반 대기열 등록 및 순번 관리.
- **티켓 예매**: 기본 예매 로직, MySQL 저장, 더미 결제 연동.
- **알림 서비스**: Kafka 이벤트와 AWS SNS로 푸시 알림 전송.
- **기본 모니터링**: Prometheus로 TPS/latency 수집, Grafana 대시보드.

### 미래 개선사항
- **고급 대기열**: 예상 대기 시간 예측, 우선순위 큐.
- **다중 알림 채널**: 이메일(SMTP), SMS(Twilio) 지원.
- **고급 모니터링**: ELK Stack으로 로그 분석, 알림 실패 재시도 로직.
- **스케일링**: Kafka 파티션 확장, Redis 클러스터링.
- **UI 개선**: 반응형 웹/모바일 앱, 다국어 지원.

---

## 논리적 의존성 체인

1. **기초 (Foundation)**:
    - **인프라 설정**: AWS EC2, EKS, RDS, ElastiCache, Kafka 설치.
    - **사용자 인증**: Spring Security와 JWT 구현 (다른 기능의 전제 조건).
    - **데이터베이스**: MySQL 스키마 생성, Redis 연결.

2. **빠른 사용자 가시성**:
    - **대기열 시스템**: Redis로 대기열 구현, 기본 UI로 순번 표시.
    - **기본 예매 UI**: 이벤트 목록, 티켓 선택 화면 (더미 데이터 사용).
    - **API**: `/api/tickets/reserve`, `/api/tickets/status` 구현.

3. **핵심 기능**:
    - **티켓 예매**: Kafka로 비동기 처리, MySQL 저장, 결제 API 연동.
    - **알림 서비스**: Kafka 이벤트 소비, AWS SNS 연동, Redis 디바이스 토큰 관리.

4. **운영 안정성**:
    - **모니터링**: Prometheus/Grafana 설정, TPS/latency/알림 성공률 메트릭.
    - **CI/CD**: Jenkins 파이프라인, Kubernetes 배포.

5. **확장 및 최적화**:
    - **성능 튜닝**: Redis 분산 락 최적화, Kafka 파티션 조정.
    - **로그 분석**: ELK Stack 통합.

---

## 리스크 및 완화 방안

### 기술적 도전
- **리스크**: Kafka의 높은 처리량 환경에서 메시지 손실.
    - **완화**: Kafka 컨슈머 그룹 최적화, Ack 모드 설정, 재시도 로직 구현.
- **리스크**: Redis의 단일 장애 지점(Single Point of Failure).
    - **완화**: Redis Sentinel 또는 클러스터 모드 적용.

### MVP 구축
- **리스크**: MVP 범위가 너무 커 개발 지연.
    - **완화**: 인증, 대기열, 기본 예매에 초점, 알림은 최소 기능(푸시만)으로 시작.
- **리스크**: 사용자 피드백 부족.
    - **완화**: 초기 테스트 사용자 그룹(10-20명) 모집, 피드백 반영.

### 자원 제약
- **리스크**: AWS 비용 초과.
    - **완화**: 무료 티어 활용, EKS 대신 로컬 Minikube로 초기 테스트.
- **리스크**: 개발 시간 부족.
    - **완화**: 모듈화된 개발, 재사용 가능한 컴포넌트 우선 구현.

---

## 부록

### 연구 결과
- **Kafka 성능**: 단일 브로커로 TPS 10,000 이상 처리 가능(Confluent 문서 참고).
- **Redis**: Sorted Set으로 대기열 관리 시 100만 사용자 처리 가능(Redis 공식 벤치마크).
- **AWS SNS**: 푸시 알림 전송 지연 1-2초 내 보장(AWS SLA).

### 기술 사양
- **Kafka**: 3개 브로커, 파티션 수 10, replication factor 2.
- **Redis**: 4GB 메모리, Sentinel 3개 노드.
- **MySQL**: InnoDB 엔진, 16GB RAM, read replica 1개.
- **Kubernetes**: 3개 노드, 각 4vCPU/8GB RAM.